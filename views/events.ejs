<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu·∫£n l√Ω s·ª± ki·ªán - C√¢y gia ph·∫£</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#f7f9fb}
    .container{max-width:1400px;margin:0 auto}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:24px}
    .header h1{margin:0;color:#333}
    .tabs{display:flex;gap:8px;border-bottom:2px solid #e5e7eb;margin-bottom:20px}
    .tab-btn{padding:12px 20px;border:none;background:none;cursor:pointer;font-size:15px;color:#666;border-bottom:3px solid transparent;transition:all 0.2s}
    .tab-btn.active{color:#16a34a;border-bottom-color:#16a34a;font-weight:600}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .panel{background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .section{background:#f9f9f9;padding:16px;border-radius:8px;margin-bottom:16px;border-left:4px solid #16a34a}
    .section h3{margin:0 0 12px;color:#333}
    .row{display:flex;gap:12px;margin-bottom:12px}
    .col{flex:1}
    .col.auto{flex:0}
    label{display:block;font-size:13px;color:#333;margin-bottom:6px;font-weight:500}
    input[type="text"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:inherit}
    textarea{resize:vertical;min-height:80px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,0.1)}
    .btn{padding:10px 16px;border-radius:6px;border:none;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s}
    .btn-primary{background:#16a34a;color:#fff}
    .btn-primary:hover{background:#15803d}
    .btn-secondary{background:#e5e7eb;color:#333}
    .btn-secondary:hover{background:#d1d5db}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{background:#dc2626}
    .btn-sm{padding:6px 12px;font-size:13px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .search-box{display:flex;gap:8px;margin-bottom:12px}
    .search-box input{flex:1}
    .member-selector{border:1px solid #ddd;border-radius:6px;max-height:250px;overflow-y:auto;background:#fff}
    .member-item{padding:8px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:8px}
    .member-item:last-child{border-bottom:none}
    .member-item label{margin:0;cursor:pointer;display:flex;align-items:center;gap:8px;flex:1}
    .member-item input[type="checkbox"]{margin:0;width:16px;height:16px}
    .selected-members{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .member-tag{background:#e8f5e9;border:1px solid #4caf50;border-radius:20px;padding:4px 12px;display:inline-flex;align-items:center;gap:6px;font-size:13px}
    .member-tag .remove{cursor:pointer;color:#c62828;font-weight:bold}
    .events-table{width:100%;border-collapse:collapse}
    .events-table thead{background:#f3f4f6}
    .events-table th{padding:12px;text-align:left;border-bottom:2px solid #ddd;font-weight:600}
    .events-table td{padding:12px;border-bottom:1px solid #eef2f7}
    .events-table tr:hover{background:#fafafa}
    .event-type{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500}
    .event-type.birthday{background:#fce7f3;color:#be185d}
    .event-type.wedding{background:#fef3c7;color:#b45309}
    .event-type.memorial{background:#fee2e2;color:#b91c1c}
    .event-type.anniversary{background:#e0e7ff;color:#3730a3}
    .event-type.other{background:#f3f4f6;color:#374151}
    .importance-high{color:#dc2626;font-weight:bold}
    .importance-normal{color:#f59e0b}
    .importance-low{color:#6b7280}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:1000}
    .modal.show{display:flex}
    .modal-dialog{background:#fff;border-radius:8px;width:600px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 25px rgba(0,0,0,0.15)}
    .modal-header{padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{margin:0}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
    .modal-body{padding:16px}
    .modal-footer{padding:16px;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:flex-end}
    .empty-state{text-align:center;padding:40px;color:#999}
    .empty-state-icon{font-size:48px;margin-bottom:12px}
    @media(max-width:768px){
      .row{flex-direction:column}
      .col.auto{flex:1}
      .modal-dialog{width:90%;max-width:500px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="font-size:32px">üìÖ</div>
      <div>
        <h1>Qu·∫£n l√Ω s·ª± ki·ªán gia ph·∫£</h1>
        <p style="margin:0;color:#666;font-size:14px">L∆∞u tr·ªØ c√°c s·ª± ki·ªán quan tr·ªçng nh∆∞ sinh nh·∫≠t, c∆∞·ªõi h·ªèi, gi·ªó, k·ª∑ ni·ªám...</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('form')">‚ûï Th√™m s·ª± ki·ªán</button>
      <button class="tab-btn" onclick="switchTab('list')">üìã Danh s√°ch s·ª± ki·ªán</button>
    </div>

    <!-- Tab: Add Event -->
    <div id="form-tab" class="tab-content active">
      <div class="panel">
        <!-- Th√¥ng tin c∆° b·∫£n -->
        <div class="section">
          <h3>üìå Th√¥ng tin c∆° b·∫£n</h3>
          <div class="row">
            <div class="col" style="flex:2">
              <label>T√™n s·ª± ki·ªán *</label>
              <input id="e-title" placeholder="VD: Sinh nh·∫≠t Nguy·ªÖn VƒÉn A" />
            </div>
            <div class="col">
              <label>Lo·∫°i s·ª± ki·ªán</label>
              <select id="e-type">
                <option value="birthday">üéÇ Sinh nh·∫≠t</option>
                <option value="wedding">üíç C∆∞·ªõi</option>
                <option value="memorial">üïØÔ∏è Gi·ªó</option>
                <option value="anniversary">üéâ K·ª∑ ni·ªám</option>
                <option value="other">üìù Kh√°c</option>
              </select>
            </div>
            <div class="col">
              <label>ƒê·ªô quan tr·ªçng</label>
              <select id="e-importance">
                <option value="low">‚≠ê B√¨nh th∆∞·ªùng</option>
                <option value="normal" selected>‚≠ê‚≠ê Quan tr·ªçng</option>
                <option value="high">‚≠ê‚≠ê‚≠ê R·∫•t quan tr·ªçng</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Th·ªùi gian & ƒë·ªãa ƒëi·ªÉm -->
        <div class="section">
          <h3>‚è∞ Th·ªùi gian & ƒë·ªãa ƒëi·ªÉm</h3>
          <div class="row">
            <div class="col">
              <label>Ng√†y di·ªÖn ra *</label>
              <input id="e-date" type="date" />
            </div>
            <div class="col">
              <label>Gi·ªù di·ªÖn ra</label>
              <input id="e-time" type="time" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>ƒê·ªãa ƒëi·ªÉm</label>
              <input id="e-place" placeholder="VD: Nh√† h√†ng Ph·ªë V√†ng, H√† N·ªôi" />
            </div>
          </div>
        </div>

        <!-- Th√†nh vi√™n li√™n quan -->
        <div class="section">
          <h3>üë• Th√†nh vi√™n li√™n quan</h3>
          <div class="row">
            <div class="col">
              <label>Th√†nh vi√™n ch√≠nh *</label>
              <select id="e-main"><option value="">(Ch·ªçn th√†nh vi√™n)</option></select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>T√¨m & th√™m th√†nh vi√™n tham gia</label>
              <div class="search-box">
                <input id="search-members" placeholder="T√¨m ki·∫øm th√†nh vi√™n..." />
                <button class="btn btn-sm btn-primary" onclick="addSelectedMembers()">+ Th√™m</button>
              </div>
              <div class="member-selector" id="member-list"></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Th√†nh vi√™n s·∫Ω tham d·ª±:</label>
              <div class="selected-members" id="selected-members"></div>
            </div>
          </div>
        </div>

        <!-- M√¥ t·∫£ & ghi ch√∫ -->
        <div class="section">
          <h3>üìù Th√¥ng tin chi ti·∫øt</h3>
          <div class="row">
            <div class="col">
              <label>M√¥ t·∫£ s·ª± ki·ªán</label>
              <textarea id="e-desc" placeholder="M√¥ t·∫£ chi ti·∫øt, √Ω nghƒ©a c·ªßa s·ª± ki·ªán, ai s·∫Ω tham gia..."></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Ghi ch√∫ th√™m</label>
              <textarea id="e-notes" placeholder="Ghi ch√∫ b·ªï sung..." style="min-height:60px"></textarea>
            </div>
          </div>
        </div>

        <!-- T√πy ch·ªçn & h√†nh ƒë·ªông -->
        <div class="section">
          <h3>üîî T√πy ch·ªçn kh√°c</h3>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <label><input type="checkbox" id="remind-7" /> Nh·∫Øc nh·ªü tr∆∞·ªõc 1 tu·∫ßn</label>
            <label><input type="checkbox" id="remind-1" /> Nh·∫Øc nh·ªü tr∆∞·ªõc 1 ng√†y</label>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="resetForm()">‚Ü∫ X√≥a h·∫øt</button>
          <button class="btn btn-primary" id="btn-save" onclick="saveEvent()">üíæ Th√™m s·ª± ki·ªán</button>
        </div>
      </div>
    </div>

    <!-- Tab: Events List -->
    <div id="list-tab" class="tab-content">
      <div class="panel">
        <div style="display:flex;gap:12px;margin-bottom:16px;align-items:center">
          <input id="search-events" type="text" placeholder="üîç T√¨m ki·∫øm s·ª± ki·ªán..." style="flex:1" />
          <button class="btn btn-secondary btn-sm" onclick="loadEventsList()">‚Ü∫ L√†m m·ªõi</button>
        </div>
        <div style="overflow-x:auto">
          <table class="events-table" id="events-table">
            <thead>
              <tr>
                <th style="width:200px">T√™n s·ª± ki·ªán</th>
                <th style="width:100px">Lo·∫°i</th>
                <th style="width:100px">Ng√†y</th>
                <th style="width:120px">ƒê·ªãa ƒëi·ªÉm</th>
                <th style="width:80px">ƒê·ªô quan tr·ªçng</th>
                <th style="width:150px;text-align:center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="events-tbody">
              <tr><td colspan="6" style="text-align:center;padding:40px;color:#999">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>S·ª≠a s·ª± ki·ªán</h3>
        <button class="modal-close" onclick="closeModal('edit-modal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col"><label>T√™n s·ª± ki·ªán</label><input id="edit-title" /></div>
        </div>
        <div class="row">
          <div class="col" style="flex:1"><label>Lo·∫°i</label><select id="edit-type"><option value="birthday">üéÇ Sinh nh·∫≠t</option><option value="wedding">üíç C∆∞·ªõi</option><option value="memorial">üïØÔ∏è Gi·ªó</option><option value="anniversary">üéâ K·ª∑ ni·ªám</option><option value="other">üìù Kh√°c</option></select></div>
          <div class="col" style="flex:1"><label>ƒê·ªô quan tr·ªçng</label><select id="edit-importance"><option value="low">‚≠ê B√¨nh th∆∞·ªùng</option><option value="normal">‚≠ê‚≠ê Quan tr·ªçng</option><option value="high">‚≠ê‚≠ê‚≠ê R·∫•t quan tr·ªçng</option></select></div>
        </div>
        <div class="row">
          <div class="col"><label>Ng√†y</label><input id="edit-date" type="date" /></div>
          <div class="col"><label>Gi·ªù</label><input id="edit-time" type="time" /></div>
        </div>
        <div class="row">
          <div class="col"><label>ƒê·ªãa ƒëi·ªÉm</label><input id="edit-place" /></div>
        </div>
        <div class="row">
          <div class="col"><label>M√¥ t·∫£</label><textarea id="edit-desc"></textarea></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('edit-modal')">H·ªßy</button>
        <button class="btn btn-primary" id="save-edit-btn" onclick="saveEditEvent()">C·∫≠p nh·∫≠t</button>
      </div>
    </div>
  </div>

  <script>
    let membersCache = [];
    let eventsCache = [];
    let currentEditId = null;
    let selectedMembers = [];

    function switchTab(tab){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab+'-tab').classList.add('active');
      event.target.classList.add('active');
      if(tab === 'list') loadEventsList();
    }

    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }

    async function loadMembers(){
      const res = await fetch('/api/members/list');
      if(!res.ok) return;
      membersCache = await res.json();
      const main = document.getElementById('e-main');
      const edit = document.getElementById('edit-main');
      main.innerHTML = '<option value="">(Ch·ªçn th√†nh vi√™n)</option>';
      if(edit) edit.innerHTML = '<option value="">(Ch·ªçn th√†nh vi√™n)</option>';
      membersCache.forEach(m=>{
        const opt = document.createElement('option');
        opt.value = JSON.stringify(m.path);
        opt.textContent = m.name + ' (Th·∫ø h·ªá ' + m.generation + ')';
        main.appendChild(opt);
        if(edit) edit.appendChild(opt.cloneNode(true));
      });
      renderMemberList();
    }

    function renderMemberList(){
      const list = document.getElementById('member-list');
      const search = (document.getElementById('search-members').value || '').toLowerCase();
      list.innerHTML = '';
      membersCache.filter(m => m.name.toLowerCase().includes(search)).forEach((m, i)=>{
        const div = document.createElement('div');
        div.className = 'member-item';
        const id = 'mcb-'+i;
        const checked = selectedMembers.some(s => JSON.stringify(s.path) === JSON.stringify(m.path));
        div.innerHTML = `<label><input type="checkbox" id="${id}" ${checked?'checked':''} data-index="${i}" /> ${m.name} <span style="color:#999;font-size:12px">(Th·∫ø h·ªá ${m.generation})</span></label>`;
        list.appendChild(div);
      });
    }

    function addSelectedMembers(){
      const checks = document.querySelectorAll('#member-list input[type=checkbox]:checked');
      checks.forEach(cb=>{
        const idx = parseInt(cb.getAttribute('data-index'));
        const m = membersCache[idx];
        if(!selectedMembers.some(s => JSON.stringify(s.path) === JSON.stringify(m.path))){
          selectedMembers.push(m);
        }
      });
      renderSelectedMembers();
      document.querySelectorAll('#member-list input[type=checkbox]').forEach(cb => cb.checked=false);
      renderMemberList();
    }

    function renderSelectedMembers(){
      const container = document.getElementById('selected-members');
      container.innerHTML = '';
      selectedMembers.forEach((m, i)=>{
        const tag = document.createElement('div');
        tag.className = 'member-tag';
        tag.innerHTML = `${m.name} <span class="remove" onclick="removeMember(${i})">‚úï</span>`;
        container.appendChild(tag);
      });
    }

    function removeMember(idx){
      selectedMembers.splice(idx, 1);
      renderSelectedMembers();
      renderMemberList();
    }

    function resetForm(){
      ['e-title','e-type','e-importance','e-date','e-time','e-place','e-desc','e-notes'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = el.tagName === 'SELECT' ? (id === 'e-importance' ? 'normal' : '') : '';
      });
      document.getElementById('e-main').selectedIndex = 0;
      selectedMembers = [];
      renderSelectedMembers();
      document.getElementById('remind-7').checked = false;
      document.getElementById('remind-1').checked = false;
    }

    async function saveEvent(){
      const title = document.getElementById('e-title').value.trim();
      const date = document.getElementById('e-date').value;
      const mainStr = document.getElementById('e-main').value;

      if(!title) return alert('Vui l√≤ng nh·∫≠p t√™n s·ª± ki·ªán');
      if(!date) return alert('Vui l√≤ng ch·ªçn ng√†y di·ªÖn ra');
      if(!mainStr) return alert('Vui l√≤ng ch·ªçn th√†nh vi√™n ch√≠nh');

      if(!confirm('X√°c nh·∫≠n th√™m s·ª± ki·ªán n√†y?')) return;

      const payload = {
        title,
        type: document.getElementById('e-type').value,
        importance: document.getElementById('e-importance').value,
        date,
        time: document.getElementById('e-time').value,
        place: document.getElementById('e-place').value,
        mainMember: JSON.parse(mainStr),
        participants: selectedMembers.map(m => m.path),
        description: document.getElementById('e-desc').value,
        notes: document.getElementById('e-notes').value,
        remind: (document.getElementById('remind-7').checked ? '7d,' : '') + (document.getElementById('remind-1').checked ? '1d' : '')
      };

      const res = await fetch('/api/events', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) return alert('Th√™m s·ª± ki·ªán th·∫•t b·∫°i');
      alert('‚úì Th√™m s·ª± ki·ªán th√†nh c√¥ng');
      resetForm();
      switchTab('list');
    }

    async function loadEventsList(){
      const tbody = document.getElementById('events-tbody');
      const res = await fetch('/api/events/list');
      if(!res.ok) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#c00">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>'; return; }
      const events = await res.json();
      eventsCache = events;

      if(events.length === 0){
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div>Ch∆∞a c√≥ s·ª± ki·ªán n√†o</div><div style="font-size:13px;margin-top:8px"><a href="javascript:switchTab(\'form\')" style="color:#16a34a">Th√™m s·ª± ki·ªán m·ªõi</a></div></div></td></tr>';
        return;
      }

      tbody.innerHTML = '';
      const search = (document.getElementById('search-events').value || '').toLowerCase();
      events.filter(e => e.title.toLowerCase().includes(search)).forEach(ev=>{
        const tr = document.createElement('tr');
        const typeEmoji = {birthday:'üéÇ',wedding:'üíç',memorial:'üïØÔ∏è',anniversary:'üéâ',other:'üìù'}[ev.type];
        const importanceClass = 'importance-' + ev.importance;
        const importanceText = {low:'B√¨nh th∆∞·ªùng',normal:'Quan tr·ªçng',high:'R·∫•t quan tr·ªçng'}[ev.importance];
        tr.innerHTML = `
          <td><strong>${escapeHtml(ev.title)}</strong></td>
          <td><span class="event-type ${ev.type}">${typeEmoji}</span></td>
          <td>${ev.date || '-'}</td>
          <td>${ev.place || '-'}</td>
          <td><span class="${importanceClass}">${importanceText}</span></td>
          <td style="text-align:center">
            <button class="btn btn-sm btn-secondary" onclick="editEvent('${ev.id}')">S·ª≠a</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEvent('${ev.id}')">X√≥a</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editEvent(id){
      const ev = eventsCache.find(e => e.id == id);
      if(!ev) return;
      currentEditId = id;
      document.getElementById('edit-title').value = ev.title;
      document.getElementById('edit-type').value = ev.type;
      document.getElementById('edit-importance').value = ev.importance;
      document.getElementById('edit-date').value = ev.date;
      document.getElementById('edit-time').value = ev.time || '';
      document.getElementById('edit-place').value = ev.place || '';
      document.getElementById('edit-desc').value = ev.description || '';
      openModal('edit-modal');
    }

    async function saveEditEvent(){
      if(!currentEditId) return;
      const payload = {
        title: document.getElementById('edit-title').value.trim(),
        type: document.getElementById('edit-type').value,
        importance: document.getElementById('edit-importance').value,
        date: document.getElementById('edit-date').value,
        time: document.getElementById('edit-time').value,
        place: document.getElementById('edit-place').value,
        description: document.getElementById('edit-desc').value
      };
      if(!payload.title) return alert('T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
      if(!payload.date) return alert('Ng√†y kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');

      const res = await fetch('/api/events/'+currentEditId, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) return alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i');
      alert('‚úì C·∫≠p nh·∫≠t th√†nh c√¥ng');
      closeModal('edit-modal');
      loadEventsList();
    }

    async function deleteEvent(id){
      if(!confirm('X√≥a s·ª± ki·ªán n√†y?')) return;
      const res = await fetch('/api/events/'+id, { method:'DELETE' });
      if(!res.ok) return alert('X√≥a th·∫•t b·∫°i');
      alert('‚úì X√≥a th√†nh c√¥ng');
      loadEventsList();
    }

    document.getElementById('search-members').addEventListener('input', renderMemberList);
    document.getElementById('search-events').addEventListener('input', loadEventsList);

    // Init
    loadMembers();
    loadEventsList();

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
  </script>
</body>
</html>
