<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Th√†nh vi√™n - C√¢y gia ph·∫£</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#f7f9fb}
    .panel{background:#fff;border-radius:8px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    label{font-size:13px;color:#333}
    input,select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    .btn{padding:10px 14px;border-radius:6px;border:none;cursor:pointer;font-size:13px;margin-right:4px}
    .btn-primary{background:#16a34a;color:#fff}
    .btn-muted{background:#e5e7eb;color:#333}
    .btn-primary:hover{background:#15803d}
    .btn-muted:hover{background:#d1d5db}
    .search-row{display:flex;gap:12px;align-items:end;margin-bottom:16px}
    .search-row>div{flex:1}
    .search-row .w-auto{flex:0}
    .results-table{width:100%;border-collapse:collapse}
    .results-table thead{background:#f3f4f6}
    .results-table th{padding:10px;text-align:left;border-bottom:2px solid #ddd;cursor:pointer;user-select:none;font-weight:600}
    .results-table th:hover{background:#e5e7eb}
    .results-table td{padding:10px;border-bottom:1px solid #eef2f7}
    .results-table tr:hover{background:#fafafa}
    .avatar-cell{display:flex;align-items:center;gap:10px}
    .avatar-img{width:40px;height:40px;border-radius:50%;background:#d1d5db;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;background-size:cover;background-position:center;flex-shrink:0}
    .member-name{font-weight:500}
    .actions{display:flex;gap:6px;justify-content:center}
    .action-link{color:#2563eb;cursor:pointer;font-size:13px;padding:2px 6px}
    .action-link:hover{text-decoration:underline;background:#eff6ff;border-radius:3px}
    .action-link.delete{color:#dc2626}
    .no-results{color:#999;padding:20px;text-align:center}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:1000}
    .modal .dialog{background:#fff;padding:20px;border-radius:10px;width:720px;max-height:85vh;overflow-y:auto}
    .modal.show{display:flex}
    .modal h3{margin-top:0}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-grid>div.full{grid-column:1/3}
    .form-group{display:flex;flex-direction:column}
    .form-group label{margin-bottom:6px}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    .modal-buttons button{padding:8px 16px}
  </style>
</head>
<body>
  <h2>Qu·∫£n l√Ω th√†nh vi√™n gia ph·∫£</h2>
  <div class="panel">
    <div class="search-row">
      <div>
        <label>T√™n th√†nh vi√™n</label>
        <input id="q-name" placeholder="Nh·∫≠p t√™n c·∫ßn t√¨m" />
      </div>
      <div class="w-auto" style="width:120px">
        <label>Th·∫ø h·ªá</label>
        <select id="q-gen"><option value="">T·∫•t c·∫£</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
      </div>
      <div class="w-auto" style="width:120px">
        <label>Gi·ªõi t√≠nh</label>
        <select id="q-gender"><option value="">T·∫•t c·∫£</option><option value="male">Nam</option><option value="female">N·ªØ</option></select>
      </div>
      <div class="w-auto" style="width:140px">
        <label>S·∫Øp x·∫øp</label>
        <select id="sort-by" onchange="changeSortOrder()"><option value="name">T√™n (A-Z)</option><option value="generation-asc">Th·∫ø h·ªá ‚Üë</option><option value="generation-desc">Th·∫ø h·ªá ‚Üì</option><option value="years">NƒÉm sinh ‚Üë</option><option value="children">Con ‚Üì</option></select>
      </div>
      <div class="w-auto">
        <button class="btn btn-primary" id="btn-search">üîç T√¨m</button>
        <button class="btn btn-muted" id="btn-reset">‚Ü∫ X√≥a</button>
      </div>
      <div class="w-auto" style="margin-left:auto">
        <button class="btn btn-primary" id="btn-add">+ Th√™m</button>
      </div>
    </div>

    <table class="results-table" id="results-table" style="display:none">
      <thead>
        <tr>
          <th onclick="sortTable('name')">üë§ T√™n</th>
          <th onclick="sortTable('generation')">Th·∫ø h·ªá</th>
          <th onclick="sortTable('years')">NƒÉm sinh/m·∫•t</th>
          <th>Gi·ªõi t√≠nh</th>
          <th onclick="sortTable('children')">Con</th>
          <th style="text-align:center;width:150px">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
    <div id="no-results" class="no-results">Kh√¥ng c√≥ k·∫øt qu·∫£</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="modal">
    <div class="dialog">
      <h3 id="modal-title">Th√™m th√†nh vi√™n m·ªõi</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>H·ªç v√† t√™n *</label>
          <input id="m-name" required />
        </div>
        <div class="form-group">
          <label>Gi·ªõi t√≠nh</label>
          <select id="m-gender"><option value="">Ch·ªçn...</option><option value="male">Nam</option><option value="female">N·ªØ</option></select>
        </div>
        <div class="form-group">
          <label>NƒÉm sinh</label>
          <input id="m-dob" type="number" min="1900" max="2099" placeholder="VD: 1980" />
        </div>
        <div class="form-group">
          <label>NƒÉm m·∫•t</label>
          <input id="m-deathYear" type="number" min="1900" max="2099" placeholder="ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a" />
        </div>
        <div class="form-group full">
          <label>M√¥ t·∫£</label>
          <textarea id="m-description" placeholder="Th√¥ng tin th√™m..." style="min-height:60px"></textarea>
        </div>
        <div class="form-group full">
          <label>·∫¢nh ƒë·∫°i di·ªán</label>
          <input type="file" id="m-image" accept="image/*" />
          <small style="color:#666;margin-top:4px;display:block">Ch·ªçn file ·∫£nh ho·∫∑c ƒë·ªÉ tr·ªëng</small>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-muted" id="modal-cancel">H·ªßy</button>
        <button class="btn btn-primary" id="modal-save">Th√™m</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div id="modal-del" class="modal">
    <div class="dialog" style="width:400px">
      <h3>X√°c nh·∫≠n x√≥a</h3>
      <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <strong id="del-name"></strong> v√† t·∫•t c·∫£ con c√°i?</p>
      <div class="modal-buttons">
        <button class="btn btn-muted" id="del-cancel">H·ªßy</button>
        <button class="btn btn-primary" style="background:#dc2626" id="del-confirm">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal-detail" class="modal">
    <div class="dialog" style="width:600px">
      <h3 id="detail-title">Th√¥ng tin chi ti·∫øt</h3>
      <div id="detail-body"></div>
      <div class="modal-buttons">
        <button class="btn btn-muted" onclick="closeModal('modal-detail')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script>
    let members = [];
    let editing = null;
    let sortKey = 'name';
    let sortOrder = 'asc'; // 'asc' or 'desc'

    function getInitials(name){ return name ? name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2) : 'A'; }

    function changeSortOrder(){
      const sel = document.getElementById('sort-by').value;
      if(sel === 'name') { sortKey = 'name'; sortOrder = 'asc'; }
      else if(sel === 'generation-asc') { sortKey = 'generation'; sortOrder = 'asc'; }
      else if(sel === 'generation-desc') { sortKey = 'generation'; sortOrder = 'desc'; }
      else if(sel === 'years') { sortKey = 'years'; sortOrder = 'asc'; }
      else if(sel === 'children') { sortKey = 'children'; sortOrder = 'desc'; }
      sortMembers(sortKey, sortOrder);
      renderResults(members);
    }

    async function loadMembers(){
      const res = await fetch('/api/members/list');
      if(!res.ok) return alert('L·ªói t·∫£i d·ªØ li·ªáu');
      members = await res.json();
      sortMembers(sortKey, sortOrder);
      renderResults(members);
    }

    function sortMembers(key, order = 'asc'){
      sortKey = key;
      sortOrder = order;
      members.sort((a, b) => {
        let cmp = 0;
        if(key === 'name') cmp = (a.name || '').localeCompare(b.name || '');
        else if(key === 'generation') cmp = (a.generation || 0) - (b.generation || 0);
        else if(key === 'children') cmp = (a.childrenCount || 0) - (b.childrenCount || 0);
        else if(key === 'years') {
          const aYear = a.node && a.node.birthYear ? a.node.birthYear : 9999;
          const bYear = b.node && b.node.birthYear ? b.node.birthYear : 9999;
          cmp = aYear - bYear;
        }
        return order === 'desc' ? -cmp : cmp;
      });
    }

    function sortTable(key){ sortMembers(key, 'asc'); renderResults(members); }

    function getImageUrl(node){
      if(!node || !node.image) return null;
      if(node.image.startsWith('/images/uploads/') || node.image.startsWith('http')) return node.image;
      return '/images/uploads/' + node.image;
    }

    function renderResults(list){
      const tbody = document.getElementById('results');
      const noResults = document.getElementById('no-results');
      const table = document.getElementById('results-table');
      tbody.innerHTML='';
      if(!list || !list.length){ table.style.display='none'; noResults.style.display='block'; return; }
      table.style.display='table'; noResults.style.display='none';
      list.forEach(m=>{
        const tr = document.createElement('tr');
        const imgUrl = getImageUrl(m.node);
        const initials = getInitials(m.name);
        const td1 = document.createElement('td');
        td1.innerHTML = `<div class="avatar-cell"><div class="avatar-img" ${imgUrl ? `style="background-image:url('${imgUrl}');color:transparent"` : `style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)"`}>${!imgUrl ? initials : ''}</div><div class="member-name">${m.name || '(ch∆∞a ƒë·∫∑t t√™n)'}</div></div>`;
        tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = m.generation || '-'; tr.appendChild(td2);
        const td3 = document.createElement('td');
        let yearText = '';
        if(m.node) {
          if(m.node.birthYear && m.node.deathYear) yearText = `${m.node.birthYear} - ${m.node.deathYear}`;
          else if(m.node.birthYear) yearText = `Sinh: ${m.node.birthYear}`;
        }
        td3.textContent = yearText || '-'; tr.appendChild(td3);
        const td4 = document.createElement('td'); td4.textContent = m.node && m.node.gender ? (m.node.gender === 'male' ? 'Nam' : 'N·ªØ') : '-'; tr.appendChild(td4);
        const td5 = document.createElement('td'); td5.textContent = m.childrenCount || 0; tr.appendChild(td5);
        const td6 = document.createElement('td'); td6.style.textAlign='center';
        const detailBtn = document.createElement('span'); detailBtn.className='action-link'; detailBtn.textContent='Chi ti·∫øt'; detailBtn.onclick=()=>openDetail(m.path);
        const editBtn = document.createElement('span'); editBtn.className='action-link'; editBtn.textContent='S·ª≠a'; editBtn.onclick=()=>openEditModal(m.path);
        const delBtn = document.createElement('span'); delBtn.className='action-link delete'; delBtn.textContent='X√≥a'; delBtn.onclick=()=>openDelete(m.path, m.name);
        td6.appendChild(detailBtn); td6.appendChild(editBtn); td6.appendChild(delBtn);
        tr.appendChild(td6);
        tbody.appendChild(tr);
      });
    }

    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }

    async function openEditModal(path){
      editing = { path };
      const m = members.find(x=> JSON.stringify(x.path) === JSON.stringify(path));
      document.getElementById('modal-title').textContent = 'Ch·ªânh s·ª≠a th√†nh vi√™n';
      document.getElementById('modal-save').textContent = 'C·∫≠p nh·∫≠t';
      if(m && m.node){
        document.getElementById('m-name').value = m.node.name || '';
        document.getElementById('m-gender').value = m.node.gender || '';
        document.getElementById('m-dob').value = m.node.birthYear || '';
        document.getElementById('m-deathYear').value = m.node.deathYear || '';
        document.getElementById('m-description').value = m.node.description || '';
      } else {
        document.getElementById('m-name').value = '';
        document.getElementById('m-gender').value = '';
        document.getElementById('m-dob').value = '';
        document.getElementById('m-deathYear').value = '';
        document.getElementById('m-description').value = '';
      }
      document.getElementById('m-image').value = '';
      openModal('modal');
    }

    function openAddModal(){
      editing = null;
      document.getElementById('modal-title').textContent = 'Th√™m th√†nh vi√™n m·ªõi';
      document.getElementById('modal-save').textContent = 'Th√™m';
      document.getElementById('m-name').value = '';
      document.getElementById('m-gender').value = '';
      document.getElementById('m-dob').value = '';
      document.getElementById('m-deathYear').value = '';
      document.getElementById('m-description').value = '';
      document.getElementById('m-image').value = '';
      openModal('modal');
    }

    async function openDetail(path){
      const params = new URLSearchParams(); params.set('path', JSON.stringify(path));
      const res = await fetch('/api/members/detail?'+params.toString());
      if(!res.ok) return alert('L·ªói t·∫£i chi ti·∫øt');
      const d = await res.json();
      const imgUrl = getImageUrl(d.node);
      document.getElementById('detail-title').textContent = d.node.name || 'Th√¥ng tin';
      let html = `<div style="display:flex;gap:16px"><div style="flex:0 0 120px;text-align:center">
        <div style="width:120px;height:120px;border-radius:50%;background:${imgUrl?'none':'linear-gradient(135deg,#667eea,#764ba2)'};${imgUrl?'background-image:url('+imgUrl+');background-size:cover;background-position:center':''}margin:0 auto;border:3px solid #ddd"></div>
      </div><div style="flex:1"><strong>Th√¥ng tin c√° nh√¢n</strong><div>H·ªç v√† t√™n: ${d.node.name||''}</div><div>Gi·ªõi t√≠nh: ${d.node.gender ? (d.node.gender==='male'?'Nam':'N·ªØ') : '-'}</div>`;
      if(d.node.birthYear) html += `<div>NƒÉm sinh: ${d.node.birthYear}</div>`;
      if(d.node.deathYear) html += `<div>NƒÉm m·∫•t: ${d.node.deathYear}</div>`;
      if(d.node.description) html += `<div style="margin-top:8px;font-size:13px;color:#666">${d.node.description}</div>`;
      html += '<div style="margin-top:12px"><strong>Gia ƒë√¨nh</strong>';
      if(d.parent) html += `<div>Cha/M·∫π: ${d.parent.name}</div>`;
      if(d.spouse) html += `<div>V·ª£/Ch·ªìng: ${d.spouse.name}</div>`;
      if(d.children && d.children.length) html += `<div>Con c√°i: ${d.children.map(c=>c.name).join(', ')}</div>`;
      html += '</div></div></div>';
      document.getElementById('detail-body').innerHTML = html;
      openModal('modal-detail');
    }

    function openDelete(path, name){
      document.getElementById('del-name').textContent = name;
      document.getElementById('del-confirm').onclick = ()=>doDelete(path);
      openModal('modal-del');
    }

    async function doDelete(path){
      const res = await fetch('/api/members', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path }) });
      if(!res.ok) return alert('X√≥a th·∫•t b·∫°i');
      closeModal('modal-del');
      await loadMembers();
    }

    document.getElementById('btn-add').onclick = openAddModal;
    document.getElementById('modal-cancel').onclick = ()=>closeModal('modal');
    document.getElementById('del-cancel').onclick = ()=>closeModal('modal-del');

    document.getElementById('modal-save').onclick = async ()=>{
      const name = document.getElementById('m-name').value.trim();
      if(!name) return alert('Vui l√≤ng nh·∫≠p t√™n');
      const birthYear = document.getElementById('m-dob').value ? parseInt(document.getElementById('m-dob').value) : null;
      const deathYear = document.getElementById('m-deathYear').value ? parseInt(document.getElementById('m-deathYear').value) : null;
      let image = null;
      const fileInput = document.getElementById('m-image');
      if(fileInput && fileInput.files && fileInput.files[0]){
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async (e)=>{
          const dataUrl = e.target.result;
          try{
            const uploadRes = await fetch('/api/tree/upload', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dataUrl}) });
            const uploadJson = await uploadRes.json();
            if(uploadRes.ok && uploadJson.filename) image = uploadJson.filename;
            else if(uploadRes.ok && uploadJson.url) image = uploadJson.url.split('/').pop();
            saveOrUpdate(name, birthYear, deathYear, image);
          } catch(err){ console.error(err); saveOrUpdate(name, birthYear, deathYear, image); }
        };
        reader.readAsDataURL(file);
      } else {
        saveOrUpdate(name, birthYear, deathYear, image);
      }
      async function saveOrUpdate(nm, by, dy, img){
        const payload = { name: nm, gender: document.getElementById('m-gender').value || null, birthYear: by, deathYear: dy, description: document.getElementById('m-description').value };
        if(img) payload.image = img;
        if(editing){
          const res = await fetch('/api/members', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path: editing.path, updates: payload }) });
          if(!res.ok) return alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i');
        } else {
          const res = await fetch('/api/members', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(Object.assign({}, payload, { parentPath: [] })) });
          if(!res.ok) return alert('Th√™m th·∫•t b·∫°i');
        }
        closeModal('modal'); await loadMembers();
      }
    };

    document.getElementById('btn-search').onclick = async ()=>{
      const q = document.getElementById('q-name').value;
      const gen = document.getElementById('q-gen').value;
      const gender = document.getElementById('q-gender').value;
      const params = new URLSearchParams();
      if(q) params.set('name', q);
      if(gen) params.set('gen', gen);
      if(gender) params.set('gender', gender);
      const res = await fetch('/api/members/search?'+params.toString());
      if(!res.ok) return alert('L·ªói t√¨m ki·∫øm');
      const data = await res.json();
      members = data.map(d=>({ name: d.name, generation: d.generation, childrenCount: (d.node && d.node.children)?d.node.children.length:0, path: d.path, node: d.node }));
      sortMembers(sortKey, sortOrder);
      renderResults(members);
    };

    document.getElementById('btn-reset').onclick = ()=>{ 
      document.getElementById('q-name').value=''; 
      document.getElementById('q-gen').value=''; 
      document.getElementById('q-gender').value=''; 
      loadMembers(); 
    };

    loadMembers();
  </script>
</body>
</html>
